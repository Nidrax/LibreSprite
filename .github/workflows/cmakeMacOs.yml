name: MacOS

on:
  push:
    branches: [ trunk ]
  pull_request:
    branches: [ trunk ]

env:
  # Customize the CMake build type here (Release, Debug, RelWithDebInfo, etc.)
  BUILD_TYPE: Release

jobs:
  build-arm64:
    runs-on: macos-latest
    if: ${{ !contains(github.event.head_commit.message, 'NO_SW_CHANGE') && !contains(github.event.pull_request.body, 'NO_SW_CHANGE') }}
    steps:
    - uses: actions/checkout@v3
    - name: install deps
      run: |
        brew install gnutls freetype jpeg webp pixman sdl2 sdl2_image tinyxml2 libarchive v8 ninja zlib xmlto dylibbundler
    - name: git
      run: |
        git submodule update --init --recursive
    - name: Build & Install GifLib 4.2.3
      run: |
        brew install autoconf automake libtool
        export CFLAGS="-Wno-implicit-function-declaration"
        curl -L https://sourceforge.net/projects/giflib/files/giflib-4.x/giflib-4.2.3.tar.gz/download --output giflib.tar.gz
        tar -xvf giflib.tar.gz
        cd giflib-4.2.3/
        ./configure
        sudo make install -j4
    - name: Build & Install libpng v1.6.50
      run: |
        git clone https://github.com/glennrp/libpng -b v1.6.50 --recursive
        cd libpng/
        ./configure
        make all -j4
        sudo make install
    - name: Download & Lint Info.plist
      run: |
        plutil desktop/Info.plist
    - name: Check for git tag
      id: check_tag
      run: |
        if git describe --exact-match --tags 2>/dev/null; then
          echo "has_tag=true" >> $GITHUB_OUTPUT
        else
          echo "has_tag=false" >> $GITHUB_OUTPUT
        fi
    - name: Get short commit hash
      id: commit
      run: |
        SHORT_HASH=$(git rev-parse --short HEAD)
        echo "short_hash=$SHORT_HASH" >> $GITHUB_OUTPUT
    - name: Update config.h with commit hash
      run: |
        sed -i '' 's/"local build"/"${{ steps.commit.outputs.short_hash }}"/g' src/config.h
    - name: Generate Makefiles
      run: |
        if [ "${{ steps.check_tag.outputs.has_tag }}" = "true" ]; then
          cmake -S . -B build -G Ninja -DCMAKE_BUILD_TYPE=Release \
            -DUSE_V8_SANDBOX=ON \
            -DRELEASE_TAG=ON \
            -DCMAKE_OSX_ARCHITECTURES=arm64 \
            -DCMAKE_OSX_SYSROOT=/Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk
        else
          cmake -S . -B build -G Ninja -DCMAKE_BUILD_TYPE=Release \
            -DUSE_V8_SANDBOX=ON \
            -DCMAKE_OSX_ARCHITECTURES=arm64 \
            -DCMAKE_OSX_SYSROOT=/Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk
        fi
    - name: Build
      run: |
        cmake --build build/ --parallel 3
        rm -f build/bin/clip_image_tests build/bin/clip_text_tests build/bin/clip_user_format_tests build/bin/gen
    - name: Generate .icns
      run: |
        mkdir besprited.iconset
        sips -z 16 16     data/icons/ase64.png --out besprited.iconset/icon_16x16.png
        sips -z 32 32     data/icons/ase64.png --out besprited.iconset/icon_16x16@2x.png
        sips -z 32 32     data/icons/ase64.png --out besprited.iconset/icon_32x32.png
        sips -z 64 64     data/icons/ase64.png --out besprited.iconset/icon_32x32@2x.png
        sips -z 128 128   data/icons/ase64.png --out besprited.iconset/icon_128x128.png
        sips -z 256 256   data/icons/ase64.png --out besprited.iconset/icon_128x128@2x.png
        sips -z 256 256   data/icons/ase64.png --out besprited.iconset/icon_256x256.png
        sips -z 512 512   data/icons/ase64.png --out besprited.iconset/icon_256x256@2x.png
        sips -z 512 512   data/icons/ase64.png --out besprited.iconset/icon_512x512.png
        sips -z 1024 1024 data/icons/ase64.png --out besprited.iconset/icon_512x512@2x.png
        iconutil -c icns -o besprited.icns besprited.iconset
        rm -R besprited.iconset
    - name: Build Apple Bundle
      run: |
        mkdir bundle/
        mkdir bundle/besprited.app
        mkdir bundle/besprited.app/Contents
        mkdir bundle/besprited.app/Contents/libs
        mkdir bundle/besprited.app/Contents/MacOS
        mkdir bundle/besprited.app/Contents/Resources
        cp ./build/bin/besprited ./bundle/besprited.app/Contents/MacOS/
        cp -r ./build/bin/data/ ./bundle/besprited.app/Contents/Resources/data/
        cp ./besprited.icns ./bundle/besprited.app/Contents/Resources/
        cp ./desktop/Info.plist ./bundle/besprited.app/Contents/
        chmod +x ./bundle/besprited.app/Contents/MacOS/besprited
    - name: Put Dylibs
      run: |
        dylibbundler -od -b -ns -x ./bundle/besprited.app/Contents/MacOS/besprited -d ./bundle/besprited.app/Contents/libs/
        
        # Check current RPATH entries after dylibbundler
        echo "RPATH entries after dylibbundler:"
        otool -l ./bundle/besprited.app/Contents/MacOS/besprited | grep -A2 LC_RPATH || echo "No RPATH entries found"
        
        # Clean up any duplicate RPATH entries from the main executable
        echo "Cleaning up RPATH entries from main executable..."
        otool -l ./bundle/besprited.app/Contents/MacOS/besprited | grep -A2 LC_RPATH | grep path | awk '{print $2}' | sort | uniq | while read -r rpath; do
            if [ ! -z "$rpath" ]; then
                echo "Removing RPATH: $rpath"
                install_name_tool -delete_rpath "$rpath" ./bundle/besprited.app/Contents/MacOS/besprited 2>/dev/null || echo "Could not remove $rpath (may not exist)"
            fi
        done
        
        # Add our RPATH cleanly
        echo "Adding single RPATH: @executable_path/../libs/"
        install_name_tool -add_rpath "@executable_path/../libs/" ./bundle/besprited.app/Contents/MacOS/besprited 2>/dev/null || echo "RPATH may already exist"
        
        # Verify final RPATH
        echo "Final RPATH entries:"
        otool -l ./bundle/besprited.app/Contents/MacOS/besprited | grep -A2 LC_RPATH || echo "No RPATH entries found"
        
        # Clean up RPATH entries in ALL bundled libraries to be thorough
        echo "Cleaning RPATH entries from all bundled libraries:"
        find ./bundle/besprited.app/Contents/libs -name "*.dylib" -type f | while read -r dylib; do
            echo "Processing: $(basename "$dylib")"
            otool -l "$dylib" | grep -A2 LC_RPATH | grep path | awk '{print $2}' | sort | uniq | while read -r rpath; do
                if [ ! -z "$rpath" ]; then
                    echo "  Removing RPATH: $rpath"
                    install_name_tool -delete_rpath "$rpath" "$dylib" 2>/dev/null || echo "  Could not remove $rpath from $(basename "$dylib")"
                fi
            done
        done

        echo "RPATH cleanup complete"
    - name: Sign Binaries
      run: |
        # Create an entitlements file to disable library validation for ad-hoc signed apps
                cat > ./bundle_entitlements.plist << EOF
                <?xml version="1.0" encoding="UTF-8"?>
                <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
                <plist version="1.0">
                <dict>
                    <key>com.apple.security.cs.disable-library-validation</key>
                    <true/>
                </dict>
                </plist>
                EOF

                # Remove all existing signatures completely
                find ./bundle/besprited.app -type f \( -name "*.dylib" -o -name "besprited" \) -exec codesign --remove-signature {} \; 2>/dev/null || true

                # Create a temporary signing script to ensure identical codesign parameters
                cat > ./sign_component.sh << 'EOF'
                #!/bin/bash
                COMPONENT="$1"
                echo "Signing: $COMPONENT"
                codesign --force --timestamp --options=runtime --entitlements ./bundle_entitlements.plist -s - "$COMPONENT"
                if [ $? -neq 0 ]; then
                    echo "Failed to sign: $COMPONENT"
                fi
                EOF
                chmod +x ./sign_component.sh

                # Sign all dylib files first using the same exact process
                find ./bundle/besprited.app/Contents/libs -name "*.dylib" -exec ./sign_component.sh {} \;

                # Sign the main executable
                ./sign_component.sh "./bundle/besprited.app/Contents/MacOS/besprited"

                # Sign the app bundle itself (without --deep since components are already signed)
                codesign --force --timestamp --options=runtime --entitlements ./bundle_entitlements.plist -s - ./bundle/besprited.app

                # Clean up
                rm ./bundle_entitlements.plist ./sign_component.sh
    - name: Create DMG
      run: |
        hdiutil create -volname "Besprited" -srcfolder bundle -ov -format UDZO "besprited.dmg"
    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: macos-arm64
        path: besprited.dmg
        if-no-files-found: error
